<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Simple home automation system ‹ some random text about funky things</title>

    <base href="/">
    <link rel="stylesheet" href="wp-content/themes/blass2/style.css" type="text/css" />
    <link rel='stylesheet' id='colorbox-theme1-css'  href='wp-content/plugins/jquery-lightbox-for-native-galleries/colorbox/theme1/colorbox-ver=1.3.14.css' type='text/css' media='screen' />

    <script type='text/javascript' src='wp-includes/js/l10n-ver=20101110.js'></script>
    <script type='text/javascript' src='wp-includes/js/jquery/jquery-ver=1.6.1.js'></script>
    <script type='text/javascript' src='wp-content/plugins/jquery-lightbox-for-native-galleries/colorbox/jquery.colorbox-min-ver=1.3.14.js'></script>
    <script type='text/javascript' src='wp-content/plugins/google-analyticator/external-tracking.min-ver=6.2.js'></script>

    <!-- /all in one seo pack -->
      <link href="wp-content/plugins/google-syntax-highlighter/Styles/SyntaxHighlighter.css" type="text/css" rel="stylesheet" />
      <!-- jQuery Lightbox For Native Galleries v3.2.2 | http://www.viper007bond.com/wordpress-plugins/jquery-lightbox-for-native-galleries/ -->
    <script type="text/javascript">
    // <![CDATA[
      jQuery(document).ready(function($){
        $(".gallery").each(function(index, obj){
          var galleryid = Math.floor(Math.random()*10000);
          $(obj).find("a").colorbox({rel:galleryid, maxWidth:"95%", maxHeight:"95%"});
        });
        $("a.lightbox").colorbox({maxWidth:"95%", maxHeight:"95%"});
      });
    // ]]>
    </script>
    <!-- Google Analytics Tracking by Google Analyticator 6.2: http://ronaldheft.com/code/analyticator/ -->
    <script type="text/javascript">
      var analyticsFileTypes = [''];
      var analyticsEventTracking = 'enabled';
    </script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3468047-1']);
      _gaq.push(['_trackPageview']);
      _gaq.push(['_trackPageLoadTime']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>

    <div ><a name='up' id='up'></a></div>

    <div id="wrapper">
      <div id="header">
        <p class="description">
          by Jan Paul Posma
        </p>
        <h1><a href="/">some random text about funky things</a></h1>
      </div>

      <div id="sidebar">
        <p class="news">Ramblings of a programmer. <a href="http://www.google.com/recaptcha/mailhide/d?k=01Hqw3Vz5N9A1b1NsDiu7sVw==&amp;c=yGzFVnjjMXotozH8E5eA2RG41nezOfvteRkOuZXNKWY=" onclick="window.open('http://www.google.com/recaptcha/mailhide/d?k\07501Hqw3Vz5N9A1b1NsDiu7sVw\75\75\46c\75yGzFVnjjMXotozH8E5eA2RG41nezOfvteRkOuZXNKWY\075', '', 'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300'); return false;">Contact me.</a></p>

        <h2>About me</h2>
        <ul>
          <li><a id='relatedlinks' href='/cv'>CV</a></li>
          <li><a id='relatedlinks' href='http://www.facebook.com/JanPaul123'>Facebook</a></li>
          <li><a id='relatedlinks' href='https://factlink.com/janpaul'>Factlink</a></li>
          <li><a id='relatedlinks' href='http://github.com/janpaul123'>Github</a></li>
          <li><a id='relatedlinks' href='http://linkedin.com/in/janpaulposma'>Linkedin</a></li>
          <li><a id='relatedlinks' href='http://www.mediawiki.org/wiki/User:JanPaul123'>MediaWiki</a></li>
          <li><a id='relatedlinks' href='http://twitter.com/JanPaul123'>Twitter</a></li>
          <li><a id='relatedlinks' href='http://www.youtube.com/user/JanPaul123'>YouTube</a></li>
        </ul>

        <p>&copy; 2009-2013</p>
      </div>

      <div id="content">
        <div class="post">

          
            <h2><a href="/simple-home-automation-system" rel="bookmark">Simple home automation system</a></h2>

            <div class="date"><small>11 March 2010</small></div>
          

          <div class="entry">
            <p><a href="photoframe.html">Last time</a> I talked about my photoframe and room control setup. It was a laptop modification, and some hacking around in cheap remote controlled switches and simple scripts. I rebuilt most of the system now: a silent PC with normal screen serves the photos, it can control the lights and devices using a commercial product, there are cameras in the room and on the street, it&#8217;s all being shown and controlled by a slick webinterface, and my grandparents are quite happy with my old photoframe in their living room. :-)</p>
<p><img src="wp-content/uploads/2010/03/IMG_0001-300x224.jpg" alt="New setup" title="New setup" width="300" height="224" class="alignnone size-medium wp-image-431" /></p>

<!--more-->

<p>Let&#8217;s get into details! The system is running on <a href="http://www.aleutia.com/products/t1">Aleutia T1</a>, which is a really nice, silent PC-ish thing. PC-ish, because the performance is not really up to todays standards, but on the other hand it&#8217;s quite cheap, really silent and comes pre-installed with Ubuntu. Cool! <span style="font-size: 80%; color: #AAA">(However, I installed Windows XP&#8230;)</span> I got mine with a <abbr title="Solid State Drive">SSD</abbr>, which means that there are no moving parts whatsoever, therefore it can stay on 24/7.</p>
<p>Using a simple <a href="http://www.apachefriends.org/en/xampp.html">XAMPP</a> setup, it runs my photoframed software mentioned in the previous post (<a href="photoframed/index.html">demo</a>, <a href="http://github.com/janpaul123/photoframed">source</a>).</p>

    <style type='text/css'>
      #gallery-1 {
        margin: auto;
      }
      #gallery-1 .gallery-item {
        float: left;
        margin-top: 10px;
        text-align: center;
        width: 33%;
      }
      #gallery-1 img {
        border: 2px solid #cfcfcf;
      }
      #gallery-1 .gallery-caption {
        margin-left: 0;
      }
    </style>
    <!-- see gallery_shortcode() in wp-includes/media.php -->
    <div id='gallery-1' class='gallery galleryid-437 gallery-columns-3 gallery-size-thumbnail'><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_0002.JPG' title='Photoframed software'><img width="150" height="111" src="wp-content/uploads/2010/03/IMG_0002-150x111.jpg" class="attachment-thumbnail" alt="Photoframed software" title="Photoframed software" /></a>
      </dt></dl><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_00011.JPG' title='Current setup'><img width="150" height="112" src="wp-content/uploads/2010/03/IMG_00011-150x112.jpg" class="attachment-thumbnail" alt="Current setup" title="Current setup" /></a>
      </dt></dl><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_0010.JPG' title='Webcams'><img width="150" height="112" src="wp-content/uploads/2010/03/IMG_0010-150x112.jpg" class="attachment-thumbnail" alt="Webcams" title="Webcams" /></a>
      </dt></dl><br style="clear: both" /><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_0008.JPG' title='Aleutia T1'><img width="150" height="112" src="wp-content/uploads/2010/03/IMG_0008-150x112.jpg" class="attachment-thumbnail" alt="Aleutia T1" title="Aleutia T1" /></a>
      </dt></dl>
      <br style='clear: both;' />
    </div>

<p>The webcam setup is quite interesting. First I tried to plug the webcams using some <abbr title="Universal Serial Bus">USB</abbr> extension cords. It was highly unstable, so now the PC is actually positioned in a cardboard box, lifted from the ground, so all the cables fit exactly.</p>
<p>Another issue with the webcams is having it stream, but also have it stream securely. A promising format seemed to be <abbr title="Motion JPEG">MJPEG</abbr>: this is just like sending out JPEG frames as fast as the connection can manage. I run the following code to generate a MJPEG stream using <abbr title="VideoLan Client">VLC</abbr>. The stream is only accessible from localhost for security reasons.</p>
<p><code><br />
vlc.exe dshow:// :dshow-vdev="USB Video Device"    :dshow-adev=none :dshow-size=640x480 --no-sout-audio --sout=#transcode{vcodec=mjpg, vb=512, fps=1, width=640, height=480}:standard{access=http{mime="multipart/x-mixed-replace; boundary=7b3cc56e5f51db803f790dad720ed50a"}, mux=mpjpeg, dst=127.0.0.1:8080/cam.mjpg}<br />
</code></p>
<p>The boundary thing is a code required for modern browsers to correctly recognize the data type. If you remove the IP-address at the end, you&#8217;ll allow anyone to watch the stream. Now the next proxy is to make sure only authenticated people are able to see the stream. I tried this using a PHP script which simply read the stream and echo&#8217;ed it (and some other variants). I also tried using the Apache proxy module. But both options have the same problem: as I have a terrible internet connection, I really need the last frame. Once a frame is transmitted, the new frame must be the most recent frame possible. However, all options I tried seem to cache the data, so you&#8217;ll see 1 second of recording spread out on, like, half a minute on the client.</p>
<p>In the end I just went with a simple script I found online somewhere, that reads exactly one MJPEG frame and spits it out as ordinary JPEG:</p>
<p><code><br />
$boundary="\n--";</p>
<p>$f = fopen($_GET['url'],"r") ;</p>
<p>if($f)<br />
{<br />
        while (substr_count($r,"Content-Length") != 2) $r.=fread($f,512);</p>
<p>        $start = strpos($r,'Ø');<br />
        $end   = strpos($r,$boundary,$start)-1;<br />
        $frame = substr("$r",$start,$end - $start);</p>
<p>        header("Content-type: image/jpeg");<br />
        echo $frame;<br />
}</p>
<p>fclose($f);<br />
</code></p>
<p>Now you have to refresh the image using for example Javascript, so that&#8217;s fine too. The webinterface I&#8217;ve written for this purpose also features a slider to set refresh interval, which is pretty handy if you&#8217;ve got a shitty connection like myself. Also, this brings me to the home automation part, which is actually pretty brief. All devices in my room are plugged into a <a href="http://klikaanklikuit.nl">KlikAanKlikUit</a> unit, and the PC&#8217;s got a <a href="http://klikaanklikuit.nl/product_detail.asp?id=25">TPC-200</a> interface plugged in, and a little bit of software does the trick (<a href="kakurc/index.html">demo</a>, <a href="http://github.com/janpaul123/kakurc">source</a>).</p>
<p>The TPC-200 interface comes with a <abbr title="Dynamic Link Library">DLL</abbr> which has one single command: <em>Send(id, value)</em>, with <em>id</em> being an integer and <em>value</em> a boolean. A simple executable wrapper, hacked together in <abbr title="Visual Basic">VB</abbr>, makes it easy to send commands from PHP, using <em>exec</em>.</p>

    <style type='text/css'>
      #gallery-2 {
        margin: auto;
      }
      #gallery-2 .gallery-item {
        float: left;
        margin-top: 10px;
        text-align: center;
        width: 33%;
      }
      #gallery-2 img {
        border: 2px solid #cfcfcf;
      }
      #gallery-2 .gallery-caption {
        margin-left: 0;
      }
    </style>
    <!-- see gallery_shortcode() in wp-includes/media.php -->
    <div id='gallery-2' class='gallery galleryid-448 gallery-columns-3 gallery-size-thumbnail'><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/mac_screenshot.png' title='Room control interface'><img width="150" height="84" src="wp-content/uploads/2010/03/mac_screenshot-150x84.png" class="attachment-thumbnail" alt="Room control interface" title="Room control interface" /></a>
      </dt></dl><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_0003.JPG' title='Webcam inside'><img width="150" height="112" src="wp-content/uploads/2010/03/IMG_0003-150x112.jpg" class="attachment-thumbnail" alt="Webcam inside" title="Webcam inside" /></a>
      </dt></dl><dl class='gallery-item'>
      <dt class='gallery-icon'>
        <a href='wp-content/uploads/2010/03/IMG_0005.JPG' title='Webcam outside'><img width="150" height="112" src="wp-content/uploads/2010/03/IMG_0005-150x112.jpg" class="attachment-thumbnail" alt="Webcam outside" title="Webcam outside" /></a>
      </dt></dl><br style="clear: both" />
      <br style='clear: both;' />
    </div>

<p>The first room control breach has happened already: I used the inferior Apache Basic Authentication for the login procedure, and it turns out that sessions can keep open for a long period of time. Even when the server restarts during that time. I logged on the system on the laptop of a friend of mine, and 3 days later, he scared the crap out of me by playing with my lights. ;-) <!-- The PC restarts every night at 5am, so I&#8217;m still amazed that the session lasted that long. --> </p>
<p>Anyway, I quickly tracked him down using the access logs and we had a good laugh about it, but I still don&#8217;t trust the security anymore: the inside camera is pointed at the ceiling now&#8230; <abbr title="Secure Sockets Layer">SSL</abbr> and stuff like that will probably be secure enough, but if you&#8217;re considering building the same setup, don&#8217;t plug in your nuclear power plant.</p>

            <p id='up'>&uarr; <a href='#up' title='Go upwards' target='_self'>Back to top</a></p>
          </div>
        </div>

      </div>
    </div>

  </body>
</html>
